% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/sc_buildAdjacency.R
\name{sc_buildAdjacency}
\alias{sc_buildAdjacency}
\title{Single‑cell coexpression adjacency per cell type (layers) from Seurat}
\usage{
sc_buildAdjacency(
  seurat_obj,
  assay = NULL,
  slot = c("data", "scale.data", "counts"),
  cell_type_col = NULL,
  feature_ids = NULL,
  use_variable_features = TRUE,
  n_features = 2000,
  min_cells_per_type = 20,
  max_cells_per_type = NULL,
  cor_method = c("spearman", "pearson", "bicor"),
  pval_adjust = c("fdr", "BH", "bonferroni", "none"),
  pval_cutoff = 0.05,
  corr_threshold = 0.25,
  layer_order = NULL,
  verbose = TRUE
)
}
\arguments{
\item{seurat_obj}{A \pkg{Seurat} object.}

\item{assay}{Character. Assay to use. If \code{NULL}, the function tries, in order,
\code{"integrated"}, \code{"SCT"}, \code{"RNA"}, then falls back to the first assay present.}

\item{slot}{Character; which slot to read from the assay. One of \code{"data"},
\code{"scale.data"}, \code{"counts"}. Default \code{"data"}.}

\item{cell_type_col}{Character; name of the metadata column with cell‑type labels.
If \code{NULL}, the function searches common candidates and errors if none are present.}

\item{feature_ids}{Optional character vector of genes to include. If \code{NULL},
the function uses \code{VariableFeatures(seurat_obj[[assay]])} when available,
otherwise selects the top \code{n_features} by row variance.}

\item{use_variable_features}{Logical; if \code{TRUE} and \code{feature_ids} is \code{NULL},
attempt to use \code{VariableFeatures}. Default \code{TRUE}.}

\item{n_features}{Integer; when \code{feature_ids} is \code{NULL} and no variable features
are stored, pick this many top‑variance genes. Default \code{2000}.}

\item{min_cells_per_type}{Integer; minimum number of cells required to build an adjacency
for a cell type. Types with fewer cells return a zero matrix. Default \code{20}.}

\item{max_cells_per_type}{Optional integer; if provided and a cell type has more cells than this,
randomly subsample to this many cells to control time/memory. Default \code{NULL} (use all).}

\item{cor_method}{Correlation method: \code{"spearman"} (default), \code{"pearson"},
or \code{"bicor"} (requires \pkg{WGCNA}).}

\item{pval_adjust}{P‑value adjustment: \code{"fdr"}, \code{"BH"}, \code{"bonferroni"},
or \code{"none"}. Default \code{"fdr"}.}

\item{pval_cutoff}{Numeric; (adjusted) p‑value cutoff for edges. Default \code{0.05}.}

\item{corr_threshold}{Numeric; absolute correlation threshold for edges. Default \code{0.25}.}

\item{layer_order}{Optional character vector to control the order of cell types in the output.}

\item{verbose}{Logical; print progress messages. Default \code{TRUE}.}
}
\value{
A named list of adjacency matrices \code{adj[[cell_type]] = matrix} (genes × genes), all with
identical row/column order. Attributes:
\itemize{
\item \code{attr(x, "gene_order")} — the gene order used across matrices.
\item \code{attr(x, "cell_types")} — the cell types included (order reflects output).
\item \code{attr(x, "assay")} and \code{attr(x, "slot")} — provenance.
}
}
\description{
Given a \pkg{Seurat} object with one or more assays (e.g., \code{"RNA"}, \code{"SCT"},
\code{"integrated"}), this function extracts an assay/slot matrix (default: \code{slot="data"}),
pulls the cell metadata, and for each \strong{cell type} (chosen via a metadata column) computes
a gene–gene correlation matrix \strong{across individual cells} of that type (no aggregation).
Edges are kept when they satisfy both an absolute correlation threshold and a p‑value cutoff.
The result is a list of adjacency matrices—one per cell type—sharing an identical gene order,
ready to be used as layers in a multilayer network.
}
\details{
Build per–cell type gene–gene adjacency matrices from a Seurat object (no aggregation)

\strong{Assay and slot.}
You can point to any assay present in the object (e.g., \code{"RNA"}, \code{"SCT"},
\code{"integrated"}) and choose the slot to read (\code{"data"} is recommended).
For typical Seurat workflows:
\itemize{
\item \code{assay="RNA", slot="data"} → log‑normalized expression (sparse).
\item \code{assay="SCT", slot="data"} → SCT residuals (already normalized).
\item \code{assay="integrated", slot="data"} → corrected expression used for integration.
}

\strong{Cell types (layers).}
The function reads \code{object@meta.data}. Set \code{cell_type_col} to the column
that contains the cell‑type labels (these labels become the layer names). If omitted,
the function tries common candidates (e.g., \code{"cell_type"}, \code{"celltype"},
\code{"CellType"}, \code{"seurat_clusters"}), and errors if none is found.

\strong{Gene universe.}
Use \code{feature_ids} to fix the genes used across all layers. If \code{feature_ids} is
\code{NULL}, the function (by default) uses \code{\link[Seurat]{VariableFeatures}} from
the selected assay if available; otherwise it picks the top \code{n_features} genes by
row variance (computed efficiently on sparse matrices). All adjacency matrices are then
padded to this common gene universe and share the same row/column order.

\strong{Correlation & statistics.}
Correlations are computed with \code{cor_method = "spearman"} (default), or
\code{"pearson"}, or robust \code{"bicor"} (requires \pkg{WGCNA}). P‑values come from
\pkg{WGCNA} (\code{corAndPvalue}) when available; otherwise the function falls back to
\pkg{Hmisc} (\code{rcorr}) for Pearson/Spearman. Adjusted p‑values are supported via
\code{pval_adjust = "fdr"|"BH"|"bonferroni"|"none"}.

\strong{Scale considerations.}
Computing correlations across cells is feasible provided you keep the gene set modest
(e.g., 1–3k genes). For very large datasets, consider limiting cells per type using
\code{max_cells_per_type}, or pass a curated \code{feature_ids}. Note that with large
numbers of cells, \strong{p‑values can be extremely small}; if you want to keep edges based
on correlation only, set \code{pval_cutoff = 1}.
}
\section{Tips}{

\itemize{
\item If you see “too few cells” messages, lower \code{min_cells_per_type} or merge rare types.
\item To keep only correlation‑based edges (ignore p‑values), set \code{pval_cutoff = 1}.
\item For very large cell counts, set \code{max_cells_per_type} (e.g., 5000–10000).
}
}

\examples{
\dontrun{
library(Seurat)
seu <- readRDS("my_seurat.rds")

adj <- sc_buildAdjacency(
  seurat_obj         = seu,
  assay              = "SCT",        # or "RNA", "integrated", etc.
  slot               = "data",
  cell_type_col      = "celltype",   # choose your metadata column
  feature_ids        = NULL,         # use VariableFeatures if present; else top-variance
  use_variable_features = TRUE,
  n_features         = 3000,
  min_cells_per_type = 30,
  max_cells_per_type = 8000,         # subsample if needed; NULL = use all
  cor_method         = "spearman",
  pval_adjust        = "fdr",
  pval_cutoff        = 0.05,
  corr_threshold     = 0.25,
  layer_order        = c("T cell","B cell","NK","Myeloid","Endothelial"),
  verbose            = TRUE
)

names(adj)                 # cell types (layers)
dim(adj[[1]])              # genes × genes (same order across layers)
attr(adj, "gene_order")[1:10]
}
}
\seealso{
\code{\link[Seurat]{GetAssayData}}, \code{\link[Seurat]{VariableFeatures}}
}
